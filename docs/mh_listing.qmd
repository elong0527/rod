---
title: "Medical History Listing"
---

::: {.callout-note}
## Objectives

This guide demonstrates Medical History (MH) listing.
:::

## Setup

```{python}
#| message: false
import os
import sys
import polars as pl
from pathlib import Path

sys.path.insert(0, 'src')

from rtflite import LibreOfficeConverter
try:
    converter = LibreOfficeConverter()
except Exception:
    converter = None
    print("WARNING: LibreOffice not found. PDF conversion will be skipped.")

from csrlite import load_plan, study_plan_to_mh_listing
from csrlite.mh.mh_listing import mh_listing
```

## Medical History Listing

Detailed listing of each subject's medical history.

## StudyPlan-Driven Workflow

```{python}
study_plan = load_plan("studies/xyz123/yaml/plan_xyz123.yaml")
study_plan.get_plan_df().filter(pl.col("analysis") == "mh_listing")
```

```{python}
output_files = study_plan_to_mh_listing(study_plan)
```

```{python}
#| echo: false
for file in output_files:
    if converter:
        converter.convert(file, output_dir="docs/pdf/", format="pdf", overwrite=True)
```

## Complete Pipeline

```{python}
# Load data
data_path = Path("data") if Path("data").exists() else Path("../data")
adsl = pl.read_parquet(data_path / "adsl.parquet")
admh = pl.read_parquet(data_path / "admh.parquet")

# Define output path for listing
output_listing_rtf = "studies/xyz123/rtf/mh_listing_manual.rtf"
# Ensure directory exists
Path(output_listing_rtf).parent.mkdir(parents=True, exist_ok=True)

listing_path = mh_listing(
    population=adsl,
    observation=admh,
    population_filter="SAFFL = 'Y'",
    observation_filter="MHOCCUR = 'Y'",
    id=("USUBJID", "Subject ID"),
    title=[
        "Listing of Medical History",
        "(Safety Population)"
    ],
    footnote=["Sorted by Treatment, Subject, and Start Date."],
    source=["Source: ADSL and ADMH datasets"],
    output_file=output_listing_rtf,
    sort_columns=["TRT01A", "USUBJID", "MHSTDTC"]
)
print(f"Generated: {listing_path}")
```

```{python}
#| echo: false
if converter:
    converter.convert("studies/xyz123/rtf/mh_listing_manual.rtf", output_dir="docs/pdf/", format="pdf", overwrite=True)
```

<embed src="pdf/mh_listing_manual.pdf" style="width:100%; height:800px" type="application/pdf">
