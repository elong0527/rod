---
title: "AE Listing"
---

::: {.callout-note}
## Objectives

This guide demonstrates AE listing showing detailed individual adverse event records with key information like severity, relationship, and outcomes. For design philosophy and architecture details, see [ae_summary.qmd](ae_summary.qmd).
:::

## Setup

```{python}
#| message: false
import sys
from pathlib import Path
import polars as pl

sys.path.insert(0, 'src')

from rtflite import LibreOfficeConverter
converter = LibreOfficeConverter()
```

```{python}
from tlfyaml import load_plan, study_plan_to_ae_listing
from tlfyaml.ae.ae_listing import ae_listing_ard, ae_listing_rtf, ae_listing
```

## What's Different?

**AE Summary** shows high-level aggregated counts (e.g., "12 (14.3%)" subjects with any AE). Uses a three-step pipeline with data pivoting.

**AE Specific** shows aggregated counts by individual event terms (e.g., "5 (6.0%)" subjects with "Diarrhea"). Uses a three-step pipeline with data pivoting.

**AE Listing** shows detailed individual event records with information like subject ID, study day, severity, relationship, action taken, and outcome. Uses a simpler two-step pipeline (no pivoting needed). Can access both population (demographics like SEX, RACE, AGE) and observation (event details) columns, with optional grouping by subject or treatment for section headers.

## StudyPlan-Driven Workflow

```{python}
study_plan = load_plan("studies/xyz123/yaml/plan_ae_xyz123.yaml")
study_plan.get_plan_df().filter(pl.col("analysis") == "ae_listing")
```

```{python}
output_files = study_plan_to_ae_listing(study_plan)
```

```{python}
#| echo: false
for file in output_files:
    converter.convert(file, output_dir="docs/pdf/", format="pdf", overwrite=True)
```

### week12_ser

<embed src="pdf/ae_listing_apat_week12_ser.pdf" style="width:100%; height:600px" type="application/pdf">

### week24_ser

<embed src="pdf/ae_listing_apat_week24_ser.pdf" style="width:100%; height:600px" type="application/pdf">

## Complete Pipeline

```{python}
adsl = pl.read_parquet("data/adsl.parquet")
adae = pl.read_parquet("data/adae.parquet")

ae_listing(
    population=adsl,
    observation=adae,
    population_filter="SAFFL = 'Y'",
    observation_filter="TRTEMFL = 'Y'",
    parameter_filter=None,
    id=("USUBJID", "Subject ID"),
    title=[
        "Listing of Participants With Adverse Events",
        "(Treatment-Emergent, Safety Population)"
    ],
    footnote=["Adverse events are sorted by subject ID and study day."],
    source=["Source: ADSL and ADAE datasets"],
    output_file="studies/xyz123/rtf/ae_listing.rtf",
    population_columns=[
        ("TRT01A", "Treatment")
    ],
    observation_columns=[
        ("AEDECOD", "Adverse Event"),
        ("ASTDY", "Study Day"),   
    ],
    sort_columns=["TRT01A", "USUBJID", "ASTDY"],
    group_by=["USUBJID"],
    page_by=["TRT01A"],
)
```

```{python}
#| echo: false
converter.convert(f"{study_plan.output_dir}/ae_listing.rtf", output_dir="docs/pdf/", format="pdf", overwrite=True)
```

<embed src="pdf/ae_listing.pdf" style="width:100%; height:600px" type="application/pdf">

## Step-by-Step Pipeline

### Step 1: Generate ARD

**Key Parameters:**
- `population_columns`: List of tuples `(column_name, label)` from population (ADSL) to include (e.g., `[("SEX", "Sex"), ("RACE", "Race")]`).
- `observation_columns`: List of tuples `(column_name, label)` from observation (ADAE) to include (e.g., `[("AEDECOD", "Adverse Event")]`).
- `sort_columns`: List of column names to sort by. If None (default), sorts by id column.
- `parameter_filter`: Optional SQL WHERE clause for filtering AEs (e.g., "AESER = 'Y'" for serious AEs)
- `page_by`: Optional list of columns to create an `__index__` column for pagination.

**Example with default (ID only):**

```{python}
_ard_minimal = ae_listing_ard(
    population=adsl,
    observation=adae,
    population_filter="SAFFL = 'Y'",
    observation_filter="TRTEMFL = 'Y'",
    parameter_filter=None,
    id=("USUBJID", "Subject ID"),
)

_ard_minimal.head(5)
```

**Example with explicit columns and pagination:**

```{python}
population_columns = [
    ("SEX", "Sex"),
    ("RACE", "Race"),
    ("AGE", "Age"),
    ("TRT01A", "Treatment")
]
observation_columns = [
    ("AEDECOD", "Adverse Event"),
    ("ASTDY", "Study Day"),
]

_ard = ae_listing_ard(
    population=adsl,
    observation=adae,
    population_filter="SAFFL = 'Y'",
    observation_filter="TRTEMFL = 'Y'",
    parameter_filter=None,
    id=("USUBJID", "Subject ID"),
    population_columns=population_columns,
    observation_columns=observation_columns,
    sort_columns=["TRT01A", "USUBJID", "ASTDY"],
    page_by=["USUBJID", "AGE", "SEX", "RACE", "TRT01A"],
)

_ard.head(10)
```

**Output Structure:** Filtered observation records joined with population data, containing selected columns from both datasets, sorted as specified.

### Step 2: Generate RTF Output

The ARD from step 1 is already display-ready (filtered and sorted), so we can generate RTF directly.

**Key Parameters:**
- `column_labels`: A dictionary mapping column names to their display labels.
- `group_by`: Optional list of column names to group by for section headers.

First, let's create the `column_labels` dictionary:

```{python}
id_col = ("USUBJID", "Subject ID")
column_labels = dict([id_col] + population_columns + observation_columns)

ae_listing_rtf(
    _ard.head(10),
    column_labels=column_labels,
    title=[
        "Adverse Event Listing",
        "(Treatment-Emergent, Safety Population)"
    ],
    footnote=["Adverse events are sorted by treatment, subject ID, and study day."],
    source=["Source: ADSL and ADAE datasets"],
    group_by=["USUBJID"],
    page_by=["__index__"],
).write_rtf("studies/xyz123/rtf/ae_listing_step.rtf")
```

```{python}
#| echo: false
converter.convert(f"{study_plan.output_dir}/ae_listing_step.rtf", output_dir="docs/pdf/", format="pdf", overwrite=True)
```

<embed src="pdf/ae_listing_step.pdf" style="width:100%; height:600px" type="application/pdf">

## Customizing Columns, Grouping, and Pagination

You can customize which columns to display, how to group sections, and how to paginate the output.

```{python}
ae_listing(
    population=adsl,
    observation=adae,
    population_filter="SAFFL = 'Y'",
    observation_filter="TRTEMFL = 'Y'",
    parameter_filter="AESER = 'Y'",  # Only serious events
    id=("USUBJID", "Subject ID"),
    title=[
        "Serious Adverse Event Listing",
        "(Treatment-Emergent, Safety Population)"
    ],
    footnote=["Listing includes only serious adverse events."],
    source=["Source: ADSL and ADAE datasets"],
    output_file="studies/xyz123/rtf/ae_listing_custom.rtf",
    population_columns=[("SEX", "Sex"), ("AGE", "Age"), ("TRT01A", "Treatment")],  # Minimal demographics
    observation_columns=[
        ("AEDECOD", "Adverse Event"),
        ("AESEV", "Severity"),
        ("AEREL", "Related"),
        ("AEOUT", "Outcome")
    ],  # Key event details
    sort_columns=["TRT01A", "USUBJID"],  # Sort by treatment and subject
    group_by=["USUBJID"],  # Group by subject for section headers
    page_by=["TRT01A", "USUBJID", "AGE", "SEX"],  # Create a new page for each treatment group
)
```

```{python}
#| echo: false
converter.convert(f"{study_plan.output_dir}/ae_listing_custom.rtf", output_dir="docs/pdf/", format="pdf", overwrite=True)
```

<embed src="pdf/ae_listing_custom.pdf" style="width:100%; height:600px" type="application/pdf">
