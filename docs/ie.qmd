---
title: "Inclusion/Exclusion Analysis"
---

::: {.callout-note}
## Objectives

This guide demonstrates Inclusion/Exclusion (IE) analysis showing Protocol Deviations.
:::

## Setup

```{python}
#| message: false
import sys
from pathlib import Path
import polars as pl

sys.path.insert(0, 'src')

from rtflite import LibreOfficeConverter
try:
    converter = LibreOfficeConverter()
except Exception:
    converter = None
    print("WARNING: LibreOffice not found. PDF conversion will be skipped.")
```

```{python}
from csrlite import load_plan, study_plan_to_ie_summary
from csrlite.ie.ie import ie_ard, ie_df, ie_rtf
```

## What's Different?

The IE analysis focuses on:
1. Identifying screening failures from ADSL/ADIE.
2. Breaking down failures by category (Inclusion vs Exclusion).
3. Detailing specific criteria failures.

## Batch Processing

Generate all IE tables defined in the study plan.

```{python}
study_plan = load_plan("studies/xyz123/yaml/plan_xyz123.yaml")
output_files = study_plan_to_ie_summary(study_plan)
print(f"Generated {len(output_files)} output files:")
for f in output_files:
    print(f"- {f}")
```

## PDF Conversion

Convert generated RTF files to PDF for preview.

```{python}
#| echo: false
for file in output_files:
    if converter:
        converter.convert(file, output_dir="docs/pdf/", format="pdf", overwrite=True)
```

## Step-by-step Implementation

### 1. Load Data

```{python}
adsl = pl.read_parquet("data/adsl.parquet")
adie = pl.read_parquet("data/adie.parquet")

print("ADSL shape:", adsl.shape)
print("ADIE shape:", adie.shape)
```

### 2. Generate ARD (Analysis Results Data)

```{python}
ard = ie_ard(
    adsl=adsl,
    adie=adie,
    group_col="TRT01A"
)
print("ARD Columns:", ard.columns)
print(ard.head())
```

### 3. Transform to Display DataFrame

```{python}
df = ie_df(ard)
# Display first few rows
from IPython.display import display, Markdown
display(df)
```

### 4. Generate RTF

```{python}
ie_rtf(
    df,
    f"{study_plan.output_dir}/ie_summary_step.rtf",
    title="Summary of Protocol Deviations (Inclusion/Exclusion)"
)
```

```{python}
#| echo: false
if converter:
    converter.convert(f"{study_plan.output_dir}/ie_summary_step.rtf", output_dir="docs/pdf/", format="pdf", overwrite=True)
```

<embed src="pdf/ie_summary_step.pdf" style="width:100%; height:800px" type="application/pdf">
