---
title: "Medical History Summary"
---

::: {.callout-note}
## Objectives

This guide demonstrates Medical History (MH) summary analysis.
:::

## Setup

```{python}
#| message: false
import os
import sys
import polars as pl
from pathlib import Path

sys.path.insert(0, 'src')

from rtflite import LibreOfficeConverter
try:
    converter = LibreOfficeConverter()
except Exception:
    converter = None
    print("WARNING: LibreOffice not found. PDF conversion will be skipped.")

from csrlite import load_plan, study_plan_to_mh_summary
from csrlite.mh.mh_summary import mh_summary
```

## Medical History Summary

Summarizes medical history by System Organ Class (SOC) and Preferred Term (PT).

## StudyPlan-Driven Workflow

```{python}
study_plan = load_plan("studies/xyz123/yaml/plan_xyz123.yaml")
study_plan.get_plan_df().filter(pl.col("analysis") == "mh_summary")
```

```{python}
output_files = study_plan_to_mh_summary(study_plan)
```

```{python}
#| echo: false
for file in output_files:
    if converter:
        converter.convert(file, output_dir="docs/pdf/", format="pdf", overwrite=True)
```

## Complete Pipeline

```{python}
# Load data
data_path = Path("data") if Path("data").exists() else Path("../data")
adsl = pl.read_parquet(data_path / "adsl.parquet")
admh = pl.read_parquet(data_path / "admh.parquet")

# Define output path for summary
output_summary_rtf = "studies/xyz123/rtf/mh_summary_manual.rtf"
# Ensure directory exists
Path(output_summary_rtf).parent.mkdir(parents=True, exist_ok=True)

summary_path = mh_summary(
    population=adsl,
    observation=admh,
    population_filter="SAFFL = 'Y'",
    observation_filter="MHOCCUR = 'Y'",
    id=("USUBJID", "Subject ID"),
    group=("TRT01A", "Treatment"),
    title=[
        "Summary of Medical History",
        "(Safety Population)"
    ],
    footnote=["Sorted by SOC and Preferred Term."],
    source=["Source: ADSL and ADMH datasets"],
    output_file=output_summary_rtf,
)
print(f"Generated: {summary_path}")
```

```{python}
#| echo: false
if converter:
    converter.convert("studies/xyz123/rtf/mh_summary_manual.rtf", output_dir="docs/pdf/", format="pdf", overwrite=True)
```

<embed src="pdf/mh_summary_manual.pdf" style="width:100%; height:800px" type="application/pdf">
